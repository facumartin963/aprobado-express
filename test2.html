<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stripe - Diagn√≥stico</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .test-button {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>üîß Diagn√≥stico Stripe</h1>
        <p>Test minimalista para identificar el problema exacto</p>
        
        <button class="test-button" onclick="testStripeKey()">
            1Ô∏è‚É£ Test Stripe Key
        </button>
        
        <button class="test-button" onclick="testPriceID()">
            2Ô∏è‚É£ Test Price ID
        </button>
        
        <button class="test-button" onclick="testCheckout()">
            3Ô∏è‚É£ Test Checkout
        </button>
        
        <button class="test-button" onclick="clearLog()">
            üóëÔ∏è Limpiar Log
        </button>
        
        <div id="log" class="log">
            <strong>üìã Log de diagn√≥stico:</strong><br>
            Haz clic en los botones para probar cada componente...<br><br>
        </div>
    </div>

    <script>
        // Definir la key expl√≠citamente
        const STRIPE_PUBLIC_KEY = 'pk_live_51Rqf4z0onb4SjYDIHfyAJJNbUK7xEgWIP6NsZnAPtv7HY6HvhsI8M08bOexKvMY5wacjTcVFJHf6MowEZkF3gKI2001CPmCSRf';
        const priceId = 'price_1RtOvw0onb4SjYDIbMYA68qY';
        
        // Inicializar Stripe correctamente
        let stripe;
        
        function initStripe() {
            try {
                stripe = Stripe(STRIPE_PUBLIC_KEY);
                log(`‚úÖ Stripe initialized with key: ${STRIPE_PUBLIC_KEY.substring(0, 25)}...`);
                return true;
            } catch (error) {
                log(`‚ùå Error initializing Stripe: ${error.message}`);
                return false;
            }
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<strong>üìã Log de diagn√≥stico:</strong><br>';
        }
        
        function testStripeKey() {
            log('üîë Testing Stripe Key...');
            
            if (!stripe) {
                log('‚ö†Ô∏è Stripe not initialized, attempting to initialize...');
                if (!initStripe()) {
                    return;
                }
            }
            
            log(`Key: ${STRIPE_PUBLIC_KEY.substring(0, 25)}...`);
            log(`Key length: ${STRIPE_PUBLIC_KEY.length} characters`);
            log(`Key starts with: ${STRIPE_PUBLIC_KEY.substring(0, 7)}`);
            
            if (STRIPE_PUBLIC_KEY.startsWith('pk_live_')) {
                log('‚úÖ This is a LIVE key');
            } else if (STRIPE_PUBLIC_KEY.startsWith('pk_test_')) {
                log('‚ö†Ô∏è This is a TEST key');
            } else {
                log('‚ùå Invalid key format');
            }
            
            if (stripe) {
                log('‚úÖ Stripe object exists and is ready');
            } else {
                log('‚ùå Stripe object not available');
            }
        }
        
        async function testPriceID() {
            log('üí∞ Testing Price ID...');
            log(`Price ID: ${priceId}`);
            log(`Price ID length: ${priceId.length} characters`);
            log(`Price ID format: ${priceId.startsWith('price_') ? 'CORRECT' : 'INCORRECT'}`);
        }
        
        async function testCheckout() {
            log('üõí Testing Stripe Checkout...');
            
            if (!stripe) {
                log('‚ùå Stripe not initialized, cannot proceed');
                return;
            }
            
            log(`Current URL: ${window.location.href}`);
            log(`Success URL would be: ${window.location.href}?success=true`);
            log(`Cancel URL would be: ${window.location.href}`);
            
            try {
                const sessionConfig = {
                    lineItems: [{
                        price: priceId,
                        quantity: 1,
                    }],
                    mode: 'payment',
                    successUrl: window.location.href + '?success=true',
                    cancelUrl: window.location.href,
                };
                
                log('üì¶ Session config created successfully');
                log('üöÄ Attempting redirectToCheckout...');
                
                const result = await stripe.redirectToCheckout(sessionConfig);
                
                if (result.error) {
                    log(`‚ùå Stripe Error Type: ${result.error.type}`);
                    log(`‚ùå Stripe Error Code: ${result.error.code}`);
                    log(`‚ùå Stripe Error Message: ${result.error.message}`);
                    
                    // An√°lisis espec√≠fico del error
                    if (result.error.type === 'invalid_request_error') {
                        log('üîç Analysis: This is likely a configuration issue');
                        if (result.error.message.includes('domain')) {
                            log('üîç Likely cause: Domain not authorized in Stripe dashboard');
                        }
                        if (result.error.message.includes('price')) {
                            log('üîç Likely cause: Price ID not found or inactive');
                        }
                    }
                } else {
                    log('‚úÖ Checkout initiated successfully - should redirect now');
                }
                
            } catch (jsError) {
                log(`üí• JavaScript Error: ${jsError.message}`);
                log(`üí• Error stack: ${jsError.stack}`);
            }
        }
        
        // Initialize Stripe on page load
        window.addEventListener('load', () => {
            log('üöÄ P√°gina cargada - iniciando diagn√≥sticos autom√°ticos...');
            initStripe();
            testStripeKey();
        });
    </script>
</body>
</html>